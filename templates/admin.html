{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div style="padding-top: 2rem;">
    <div class="dashboard-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1
            style="margin: 0; background: none; -webkit-background-clip: unset; background-clip: unset; color: var(--text-main); text-align: left;">
            Admin Dashboard</h1>
        <div class="actions" style="display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="document.getElementById('backupModal').style.display='block'"
                style="background: var(--warning); border-color: var(--warning);">
                <i class="fas fa-database"></i> Backup/Restore
            </button>
            <a href="{{ url_for('master_sheet') }}" class="btn btn-primary" style="background: var(--success);">
                <i class="fas fa-table"></i> Master Sheet
            </a>
            <a href="{{ url_for('promote_students') }}" class="btn btn-primary" style="background: var(--info);">
                <i class="fas fa-graduation-cap"></i> Promotions
            </a>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="fas fa-plus"></i> New Preset
            </button>
        </div>
    </div>

    <div class="grid">
        {% for preset in presets %}
        <div class="glass card">
            <div
                style="position: absolute; top:0; right:0; padding: 0.5rem 1rem; background: var(--primary); border-radius: 0 0 0 10px; font-size: 0.8rem;">
                {{ preset[1] }}
            </div>
            <h3>{{ preset[3] or 'General' }} - {{ preset[4] }}</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                <i class="fas fa-layer-group"></i> Div {{ preset[5] }} &bull; Sem {{ preset[6] }}
            </p>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <a href="{{ url_for('manage_subjects', preset_id=preset[0]) }}" class="btn btn-primary"
                    style="font-size: 0.9rem;">
                    <i class="fas fa-book"></i> Subjects
                </a>
                <div style="display: flex; gap: 0.5rem;">
                    <!-- Pass data via attributes to avoid JS Syntax Errors -->
                    <button class="btn btn-primary" style="flex: 1; font-size: 0.8rem; background: var(--secondary);"
                        onclick="openDuplicateModal(this)" data-id="{{ preset[0] }}"
                        data-academic-year="{{ preset[1] }}" data-course="{{ preset[2] }}"
                        data-department="{{ preset[3] }}" data-year="{{ preset[4] }}" data-division="{{ preset[5] }}"
                        data-semester="{{ preset[6] }}">
                        <i class="fas fa-copy"></i> Clone
                    </button>
                    <button class="btn btn-primary"
                        style="flex: 1; font-size: 0.8rem; background: var(--accent); border-color: var(--accent);"
                        onclick="openEditModal(this)" data-id="{{ preset[0] }}" data-academic-year="{{ preset[1] }}"
                        data-course="{{ preset[2] }}" data-department="{{ preset[3] }}" data-year="{{ preset[4] }}"
                        data-division="{{ preset[5] }}" data-semester="{{ preset[6] }}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <a href="{{ url_for('delete_preset', preset_id=preset[0]) }}" class="btn btn-danger"
                        style="flex: 0.5; font-size: 0.8rem; display:flex; align-items:center; justify-content:center; background: var(--danger); border-color: var(--danger);"
                        onclick="return confirm('Are you sure you want to delete this preset?');">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="glass card" style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
            <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
            <h3>No Presets Found</h3>
            <p style="color: var(--text-muted);">Create a class preset to get started.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add/Edit Preset Modal -->
<div id="presetModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.6); z-index: 1000; backdrop-filter: blur(8px);">
    <div class="glass"
        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 2rem; width: 90%; max-width: 500px; box-shadow: var(--shadow-xl); border: 1px solid var(--glass-border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="modalTitle" style="margin: 0; font-size: 1.5rem; color: var(--text-main);">Add New Preset</h2>
            <button onclick="closeModal()"
                style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <form id="presetForm" method="post">
            <div class="form-group">
                <label>Academic Year</label>
                <input type="text" id="academic_year" name="academic_year" placeholder="e.g. 2025-26" required>
            </div>

            <!-- Hidden Course Field (Fixed to BE) -->
            <input type="hidden" id="course" name="course" value="BE">

            <div class="form-group">
                <label>Department</label>
                <select id="department" name="department" required>
                    <option value="" disabled selected>Select Department</option>
                    <option value="Computer Engineering">Computer Engineering</option>
                    <option value="AI & ML">AI & ML</option>
                    <option value="Electronics & Computer Science">Electronics & Computer Science (ECS)</option>
                    <option value="Mechanical Engineering">Mechanical Engineering</option>
                    <option value="Information Technology">Information Technology</option>
                </select>
            </div>

            <div style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label>Year</label>
                    <select id="year" name="year" required>
                        <option value="FE">FE</option>
                        <option value="SE">SE</option>
                        <option value="TE">TE</option>
                        <option value="BE">BE</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Division</label>
                    <input type="text" id="division" name="division" placeholder="e.g. A" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Semester</label>
                    <input type="text" id="semester" name="semester" placeholder="e.g. 3" required>
                </div>
            </div>
            <button type="submit" id="modalSubmitBtn" class="btn btn-primary"
                style="width: 100%; margin-top: 1rem;">Create Preset</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()"
                style="width: 100%; margin-top: 0.5rem; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);">
                Close
            </button>
        </form>
    </div>
</div>

<!-- Backup/Restore Modal -->
<div id="backupModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.6); z-index: 1000; backdrop-filter: blur(8px);">
    <div class="glass"
        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 2rem; width: 90%; max-width: 500px; box-shadow: var(--shadow-xl); border: 1px solid var(--glass-border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-main);">Database Management</h2>
            <button onclick="document.getElementById('backupModal').style.display='none'"
                style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--glass-border);">
            <h3>Backup</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">Download a copy of the current
                database.</p>
            <a href="{{ url_for('download_db') }}" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-download"></i> Download Database
            </a>
        </div>

        <div>
            <h3>Restore</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">Upload a database file to
                replace the current one. <span style="color: var(--danger);">Warning: This overwrites current
                    data!</span></p>
            <form action="{{ url_for('upload_db') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="db_file" accept=".db" required style="margin-bottom: 1rem;">
                <button type="submit" class="btn btn-danger"
                    style="width: 100%; background: var(--danger); border-color: var(--danger);"
                    onclick="return confirm('Are you sure you want to overwrite the database? This cannot be undone.');">
                    <i class="fas fa-upload"></i> Restore Database
                </button>
            </form>
        </div>

        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
            <h3>Migrate Old Database</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                Upload an old database backup to automatically convert it to the new schema.
                <span style="color: var(--info);">âœ¨ Recommended for old backups!</span>
            </p>
            <form action="{{ url_for('migrate_db') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="db_file" accept=".db" required style="margin-bottom: 1rem;">
                <button type="submit" class="btn btn-primary" style="width: 100%; background: var(--info);"
                    onclick="return confirm('This will migrate and apply the old database. Your current database will be backed up first. Continue?');">
                    <i class="fas fa-magic"></i> Migrate & Apply
                </button>
            </form>
            <p style="color: var(--text-dim); margin-top: 0.5rem; font-size: 0.8rem;">
                ðŸ’¡ This converts INTEGER fields to REAL and updates grading rules automatically.
            </p>
            <button type="button" class="btn btn-secondary"
                onclick="document.getElementById('backupModal').style.display='none'"
                style="width: 100%; margin-top: 1rem; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    function openAddModal() {
        document.getElementById('modalTitle').innerText = 'Add New Preset';
        document.getElementById('presetForm').action = "{{ url_for('add_preset') }}";
        document.getElementById('modalSubmitBtn').innerText = 'Create Preset';

        document.getElementById('academic_year').value = '';
        document.getElementById('course').value = 'BE';
        document.getElementById('department').value = '';
        document.getElementById('year').value = 'FE';
        document.getElementById('division').value = '';
        document.getElementById('semester').value = '';

        document.getElementById('presetModal').style.display = 'block';
    }

    function openEditModal(btn) {
        document.getElementById('modalTitle').innerText = 'Edit Preset';
        const id = btn.dataset.id;
        var url = "{{ url_for('edit_preset', preset_id=0) }}".replace('0', id);

        document.getElementById('presetForm').action = url;
        document.getElementById('modalSubmitBtn').innerText = 'Update Preset';

        document.getElementById('academic_year').value = btn.dataset.academicYear;
        // Course is hidden but set it anyway
        document.getElementById('course').value = btn.dataset.course || 'BE';
        document.getElementById('department').value = btn.dataset.department;
        document.getElementById('year').value = btn.dataset.year;
        document.getElementById('division').value = btn.dataset.division;
        document.getElementById('semester').value = btn.dataset.semester;

        document.getElementById('presetModal').style.display = 'block';
    }

    function openDuplicateModal(btn) {
        document.getElementById('modalTitle').innerText = 'Duplicate Preset (Deep Copy)';
        const id = btn.dataset.id;
        var url = "{{ url_for('duplicate_preset', preset_id=0) }}".replace('0', id);

        document.getElementById('presetForm').action = url;
        document.getElementById('modalSubmitBtn').innerText = 'Clone & Copy Subjects';

        document.getElementById('academic_year').value = btn.dataset.academicYear;
        document.getElementById('course').value = btn.dataset.course || 'BE';
        document.getElementById('department').value = btn.dataset.department;
        document.getElementById('year').value = btn.dataset.year;
        document.getElementById('division').value = '';
        document.getElementById('semester').value = btn.dataset.semester;

        document.getElementById('presetModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('presetModal').style.display = 'none';
    }
</script>
{% endblock %}